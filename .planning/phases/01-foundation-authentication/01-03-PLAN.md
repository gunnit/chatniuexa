---
phase: 01-foundation-authentication
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/middleware.ts
  - src/lib/dal/auth.ts
autonomous: true

must_haves:
  truths:
    - "Middleware refreshes auth session on every request"
    - "verifySession function redirects to /login if not authenticated"
    - "getUser function returns current user or null"
    - "verifySession is cached per-request for performance"
  artifacts:
    - path: "src/middleware.ts"
      provides: "Root middleware for session refresh"
      contains: "updateSession"
    - path: "src/lib/dal/auth.ts"
      provides: "Data Access Layer for authentication"
      exports: ["verifySession", "getUser"]
  key_links:
    - from: "src/middleware.ts"
      to: "src/lib/supabase/middleware.ts"
      via: "import updateSession"
      pattern: "import.*updateSession.*from.*supabase/middleware"
    - from: "src/lib/dal/auth.ts"
      to: "src/lib/supabase/server.ts"
      via: "import createClient"
      pattern: "import.*createClient.*from.*supabase/server"
    - from: "src/lib/dal/auth.ts"
      to: "supabase.auth.getUser"
      via: "JWT validation"
      pattern: "supabase\\.auth\\.getUser"
---

<objective>
Create the middleware for automatic session refresh and the Data Access Layer (DAL) for authentication checks.

Purpose: Ensure sessions stay fresh across navigation and provide a centralized, cached way to verify authentication in Server Components and Server Actions.
Output: Root middleware and auth DAL functions that all protected pages will use.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create root middleware for session refresh</name>
  <files>
    src/middleware.ts
  </files>
  <action>
    Create the root middleware that refreshes auth sessions on every request.

    Implementation:
    1. Import `updateSession` from `@/lib/supabase/middleware`
    2. Export async `middleware` function that calls `updateSession(request)`
    3. Export `config` with matcher that excludes static files:
       ```typescript
       export const config = {
         matcher: [
           '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
         ],
       }
       ```

    This middleware:
    - Runs on every page navigation and API call (except static assets)
    - Calls updateSession which validates the JWT and refreshes tokens if needed
    - Sets updated cookies on the response

    CRITICAL: The updateSession function uses getUser() internally (not getSession) to validate the JWT with Supabase Auth servers. This is the secure pattern.
  </action>
  <verify>
    - File exists at src/middleware.ts
    - TypeScript compiles: `npx tsc --noEmit`
    - Middleware exports both `middleware` function and `config`
    - Config matcher excludes static files
  </verify>
  <done>
    Root middleware exists and will refresh sessions on every request
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Data Access Layer for authentication</name>
  <files>
    src/lib/dal/auth.ts
  </files>
  <action>
    Create the Data Access Layer with cached session verification following Next.js patterns.

    Implementation:
    1. Import `cache` from 'react'
    2. Import `redirect` from 'next/navigation'
    3. Import `createClient` from '@/lib/supabase/server'

    4. Create `verifySession` (cached):
       ```typescript
       export const verifySession = cache(async () => {
         const supabase = await createClient()

         // CRITICAL: Use getUser() not getSession() for server-side validation
         const { data: { user }, error } = await supabase.auth.getUser()

         if (error || !user) {
           redirect('/login')
         }

         // Get tenant_id from profile (not app_metadata yet - we'll use profile lookup)
         const { data: profile } = await supabase
           .from('profiles')
           .select('tenant_id')
           .eq('id', user.id)
           .single()

         return {
           isAuth: true,
           userId: user.id,
           email: user.email,
           tenantId: profile?.tenant_id || null
         }
       })
       ```

    5. Create `getUser` (cached):
       ```typescript
       export const getUser = cache(async () => {
         const supabase = await createClient()
         const { data: { user } } = await supabase.auth.getUser()
         return user
       })
       ```

    The `cache()` wrapper ensures these functions are only called once per request, even if multiple components call them.

    IMPORTANT: verifySession redirects to /login if not authenticated. Use this in protected pages.
    Use getUser when you need optional user data (e.g., showing login/logout button).
  </action>
  <verify>
    - File exists at src/lib/dal/auth.ts
    - TypeScript compiles: `npx tsc --noEmit`
    - Exports verifySession and getUser functions
    - Uses cache() wrapper for both functions
    - Uses getUser() (not getSession()) for JWT validation
  </verify>
  <done>
    DAL provides cached verifySession (redirects if not auth) and getUser (returns user or null)
  </done>
</task>

</tasks>

<verification>
1. Both files exist with correct exports
2. TypeScript compiles without errors
3. Middleware uses updateSession from lib/supabase/middleware
4. DAL uses createClient from lib/supabase/server
5. DAL uses getUser() (not getSession()) for validation
6. DAL functions are wrapped with cache()
</verification>

<success_criteria>
- Root middleware automatically refreshes auth sessions
- verifySession provides cached, secure session validation with redirect
- getUser provides cached user lookup without redirect
- All functions use the secure getUser() pattern (not getSession)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-03-SUMMARY.md`
</output>
