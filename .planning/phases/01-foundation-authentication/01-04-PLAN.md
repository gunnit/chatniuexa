---
phase: 01-foundation-authentication
plan: 04
type: execute
wave: 3
depends_on: ["01-01", "01-02", "01-03"]
files_modified:
  - src/app/(auth)/signup/page.tsx
  - src/app/(auth)/signup/actions.ts
  - src/app/(auth)/signup/check-email/page.tsx
  - src/app/(auth)/auth/confirm/route.ts
  - src/app/(auth)/auth/error/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can see signup form at /signup"
    - "User can submit signup with email, password, and name"
    - "Signup creates both tenant and profile records"
    - "User is redirected to check-email page after signup"
    - "Email confirmation link works and creates session"
  artifacts:
    - path: "src/app/(auth)/signup/page.tsx"
      provides: "Signup form UI"
      min_lines: 30
    - path: "src/app/(auth)/signup/actions.ts"
      provides: "Signup server action"
      exports: ["signup"]
    - path: "src/app/(auth)/auth/confirm/route.ts"
      provides: "Email confirmation handler"
      exports: ["GET"]
  key_links:
    - from: "src/app/(auth)/signup/actions.ts"
      to: "supabase.auth.signUp"
      via: "server action"
      pattern: "supabase\\.auth\\.signUp"
    - from: "src/app/(auth)/signup/actions.ts"
      to: "tenants table"
      via: "insert"
      pattern: "from\\('tenants'\\)"
    - from: "src/app/(auth)/auth/confirm/route.ts"
      to: "supabase.auth.verifyOtp"
      via: "token exchange"
      pattern: "supabase\\.auth\\.verifyOtp"
---

<objective>
Implement the complete signup flow with tenant creation and email confirmation.

Purpose: Enable new users to create accounts. Each signup creates a new tenant (for multi-tenant isolation) and links the user's profile to that tenant.
Output: Working signup page, server action, and email confirmation handler.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-01-SUMMARY.md
@.planning/phases/01-foundation-authentication/01-02-SUMMARY.md
@.planning/phases/01-foundation-authentication/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create signup page with form</name>
  <files>
    src/app/(auth)/signup/page.tsx
    src/app/(auth)/signup/check-email/page.tsx
  </files>
  <action>
    Create the signup page as a Client Component with form:

    1. `src/app/(auth)/signup/page.tsx`:
       - Use 'use client' directive (needed for useActionState)
       - Import `useActionState` from 'react' and `signup` action
       - Form fields: fullName, email, password (all required)
       - Password field should have minLength={8}
       - Use useActionState to handle form submission and show errors
       - Display error messages from server action state
       - Include link to /login for existing users
       - Style with Tailwind: centered card layout, clean form design

       Form structure:
       ```tsx
       'use client'

       import { useActionState } from 'react'
       import { signup } from './actions'
       import Link from 'next/link'

       export default function SignupPage() {
         const [state, formAction, pending] = useActionState(signup, null)

         return (
           <div className="min-h-screen flex items-center justify-center">
             <div className="max-w-md w-full p-8 bg-white rounded-lg shadow">
               <h1 className="text-2xl font-bold mb-6">Create Account</h1>
               <form action={formAction}>
                 {/* fullName, email, password fields */}
                 {/* Show state?.error if exists */}
                 {/* Submit button with pending state */}
               </form>
               <p className="mt-4 text-center text-sm">
                 Already have an account? <Link href="/login">Log in</Link>
               </p>
             </div>
           </div>
         )
       }
       ```

    2. `src/app/(auth)/signup/check-email/page.tsx`:
       - Simple page instructing user to check their email
       - Message: "Check your email for a confirmation link"
       - Link back to /login
  </action>
  <verify>
    - Both pages exist
    - TypeScript compiles: `npx tsc --noEmit`
    - Signup page renders at /signup (npm run dev)
    - Check-email page renders at /signup/check-email
  </verify>
  <done>
    Signup form page and check-email page exist with proper styling
  </done>
</task>

<task type="auto">
  <name>Task 2: Create signup server action</name>
  <files>
    src/app/(auth)/signup/actions.ts
  </files>
  <action>
    Create the signup server action with tenant creation:

    Implementation:
    ```typescript
    'use server'

    import { redirect } from 'next/navigation'
    import { createClient } from '@/lib/supabase/server'
    import { z } from 'zod'

    const signupSchema = z.object({
      fullName: z.string().min(1, 'Name is required'),
      email: z.string().email('Invalid email address'),
      password: z.string().min(8, 'Password must be at least 8 characters'),
    })

    export async function signup(prevState: any, formData: FormData) {
      const supabase = await createClient()

      const validatedFields = signupSchema.safeParse({
        fullName: formData.get('fullName'),
        email: formData.get('email'),
        password: formData.get('password'),
      })

      if (!validatedFields.success) {
        return {
          error: validatedFields.error.flatten().fieldErrors,
        }
      }

      const { fullName, email, password } = validatedFields.data

      // 1. Create tenant first (for multi-tenant isolation)
      const { data: tenant, error: tenantError } = await supabase
        .from('tenants')
        .insert({ name: `${fullName}'s Workspace` })
        .select()
        .single()

      if (tenantError) {
        return { error: 'Failed to create workspace. Please try again.' }
      }

      // 2. Sign up the user
      const { data: authData, error: authError } = await supabase.auth.signUp({
        email,
        password,
        options: {
          emailRedirectTo: `${process.env.NEXT_PUBLIC_SITE_URL}/auth/confirm`,
          data: {
            full_name: fullName,
          }
        }
      })

      if (authError) {
        // Rollback tenant creation on auth failure
        await supabase.from('tenants').delete().eq('id', tenant.id)
        return { error: authError.message }
      }

      // 3. Create profile linking user to tenant
      // NOTE: This uses the service role implicitly through RLS bypass for insert
      // The profile INSERT policy allows users to insert their own profile
      if (authData.user) {
        const { error: profileError } = await supabase
          .from('profiles')
          .insert({
            id: authData.user.id,
            tenant_id: tenant.id,
            full_name: fullName,
          })

        if (profileError) {
          console.error('Profile creation error:', profileError)
          // Profile creation might fail if user already exists
          // Continue anyway - they can still confirm their email
        }
      }

      redirect('/signup/check-email')
    }
    ```

    Key points:
    - Validates input with zod
    - Creates tenant before user (for tenant_id reference)
    - Rolls back tenant if auth fails
    - Creates profile linking user to tenant
    - Redirects to check-email page on success
  </action>
  <verify>
    - File exists at src/app/(auth)/signup/actions.ts
    - TypeScript compiles: `npx tsc --noEmit`
    - Exports signup function
    - Uses zod validation
    - Creates tenant before user signup
  </verify>
  <done>
    Signup action creates tenant, user, and profile, validates with zod, handles errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Create email confirmation handler</name>
  <files>
    src/app/(auth)/auth/confirm/route.ts
    src/app/(auth)/auth/error/page.tsx
  </files>
  <action>
    Create the email confirmation route handler and error page:

    1. `src/app/(auth)/auth/confirm/route.ts`:
       ```typescript
       import { type EmailOtpType } from '@supabase/supabase-js'
       import { type NextRequest, NextResponse } from 'next/server'
       import { createClient } from '@/lib/supabase/server'

       export async function GET(request: NextRequest) {
         const { searchParams } = new URL(request.url)
         const token_hash = searchParams.get('token_hash')
         const type = searchParams.get('type') as EmailOtpType | null
         const next = searchParams.get('next') ?? '/dashboard'

         if (token_hash && type) {
           const supabase = await createClient()

           const { error } = await supabase.auth.verifyOtp({
             type,
             token_hash,
           })

           if (!error) {
             // Successfully verified - redirect to dashboard
             return NextResponse.redirect(new URL(next, request.url))
           }
         }

         // Invalid or expired token - redirect to error page
         return NextResponse.redirect(new URL('/auth/error', request.url))
       }
       ```

    2. `src/app/(auth)/auth/error/page.tsx`:
       ```tsx
       import Link from 'next/link'

       export default function AuthErrorPage() {
         return (
           <div className="min-h-screen flex items-center justify-center">
             <div className="max-w-md w-full p-8 bg-white rounded-lg shadow text-center">
               <h1 className="text-2xl font-bold mb-4 text-red-600">
                 Authentication Error
               </h1>
               <p className="text-gray-600 mb-6">
                 The confirmation link is invalid or has expired.
                 Please try signing up again.
               </p>
               <Link
                 href="/signup"
                 className="text-blue-600 hover:underline"
               >
                 Back to Sign Up
               </Link>
             </div>
           </div>
         )
       }
       ```
  </action>
  <verify>
    - Both files exist
    - TypeScript compiles: `npx tsc --noEmit`
    - Route handler exports GET function
    - Error page renders at /auth/error
  </verify>
  <done>
    Email confirmation handler exchanges token for session, error page handles invalid links
  </done>
</task>

</tasks>

<verification>
1. All signup-related files exist
2. TypeScript compiles without errors
3. /signup shows form
4. /signup/check-email shows confirmation message
5. /auth/error shows error message
6. Server action uses zod validation and creates tenant + profile
</verification>

<success_criteria>
- Signup form accepts name, email, password with validation
- Signup creates tenant, user, and profile in correct order
- Email confirmation link is generated with correct redirect URL
- Confirmation route handler exchanges token for session
- Error states are handled gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-04-SUMMARY.md`
</output>
