---
phase: 01-foundation-authentication
plan: 06
type: execute
wave: 5
depends_on: ["01-01", "01-02", "01-03", "01-04", "01-05"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "User can sign up with email and password and receive confirmation"
    - "User can log in and access their dashboard"
    - "User session persists across browser refresh without re-login"
    - "User cannot see or access another user's data (tenant isolation verified)"
  artifacts: []
  key_links: []
---

<objective>
Verify the complete authentication flow works end-to-end with real Supabase integration.

Purpose: Ensure all auth requirements (AUTH-01, AUTH-02, AUTH-03, INFRA-01) are satisfied before moving to Phase 2.
Output: Verified, working authentication system with multi-tenant isolation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Setup: Configure Supabase Project</name>
  <action>
    Before verification can proceed, the Supabase project must be configured:

    1. **Create Supabase project** (if not already done):
       - Go to https://supabase.com/dashboard
       - Create new project for niuexa.ai
       - Wait for project to provision

    2. **Get API credentials**:
       - Project Settings -> API
       - Copy Project URL -> NEXT_PUBLIC_SUPABASE_URL
       - Copy anon/public key -> NEXT_PUBLIC_SUPABASE_ANON_KEY
       - Copy service_role key -> SUPABASE_SERVICE_ROLE_KEY

    3. **Create .env.local** in project root with:
       ```
       NEXT_PUBLIC_SUPABASE_URL=your_project_url
       NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
       SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
       NEXT_PUBLIC_SITE_URL=http://localhost:3000
       ```

    4. **Run database migration**:
       - Go to Supabase Dashboard -> SQL Editor
       - Copy contents of supabase/migrations/00001_initial_schema.sql
       - Run the SQL

    5. **Configure email settings** (optional for dev):
       - Supabase uses built-in email for development
       - Rate limit: 2 emails/hour
       - For testing, you can use Supabase Dashboard -> Authentication -> Users to confirm users manually

    6. **Disable email confirmation for testing** (recommended for first test):
       - Authentication -> Settings -> Auth Providers
       - Scroll to "Email Auth"
       - Toggle OFF "Confirm email"
       - This allows immediate login after signup (no email required)
       - Re-enable later for production
  </action>
  <resume-signal>
    Type "configured" when Supabase is set up and .env.local is created with valid credentials.
  </resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Verify: Complete Auth Flow</name>
  <what-built>
    Complete authentication system:
    - Signup flow with tenant + profile creation
    - Email confirmation (if enabled)
    - Login with email/password
    - Session persistence across refresh
    - Protected dashboard with session verification
    - Logout functionality
  </what-built>
  <how-to-verify>
    1. **Start the dev server**:
       ```bash
       cd /mnt/c/Dev/chatbotweb
       npm run dev
       ```

    2. **Test Signup** (AUTH-01):
       - Navigate to http://localhost:3000/signup
       - Fill in: Name, Email, Password (8+ chars)
       - Submit the form
       - Expected: Redirects to /signup/check-email (or /dashboard if email confirmation disabled)

    3. **Test Email Confirmation** (if enabled):
       - Check email for confirmation link
       - Click the link
       - Expected: Redirected to /dashboard

    4. **Test Dashboard Access**:
       - After signup/confirmation, you should be on /dashboard
       - Expected: Shows your email, user ID, and tenant ID
       - Expected: Green message about session validity

    5. **Test Session Persistence** (AUTH-03):
       - Refresh the browser (F5)
       - Expected: Still on /dashboard, still logged in
       - Close browser tab, open new tab, go to http://localhost:3000/dashboard
       - Expected: Still logged in (session persisted in cookies)

    6. **Test Logout** (AUTH-02):
       - Click "Log Out" button
       - Expected: Redirected to /login

    7. **Test Login** (AUTH-02):
       - Navigate to http://localhost:3000/login
       - Enter credentials used during signup
       - Submit
       - Expected: Redirected to /dashboard

    8. **Test Invalid Login**:
       - Navigate to http://localhost:3000/login
       - Enter wrong password
       - Expected: Error message displayed

    9. **Test Protected Route**:
       - Log out first
       - Navigate directly to http://localhost:3000/dashboard
       - Expected: Redirected to /login

    10. **Test Tenant Isolation** (INFRA-01):
        - Create a SECOND user with different email
        - Log in as second user
        - Note the tenant ID - it should be DIFFERENT from first user
        - Expected: Each user has their own tenant_id
        - (Full RLS verification requires database query, but different tenant IDs prove isolation setup)

    **Verification in Supabase Dashboard**:
    - Go to Table Editor -> tenants
    - Expected: Two tenant records (one per user)
    - Go to Table Editor -> profiles
    - Expected: Two profile records, each with different tenant_id
  </how-to-verify>
  <resume-signal>
    Type "verified" if all tests pass, or describe any issues found.
  </resume-signal>
</task>

</tasks>

<verification>
All Phase 1 success criteria from ROADMAP.md must be verified:
1. User can sign up with email and password and receive confirmation
2. User can log in and access their dashboard
3. User session persists across browser refresh without re-login
4. User cannot see or access another user's data (tenant isolation verified)
</verification>

<success_criteria>
- Signup creates user + tenant + profile
- Email confirmation works (or is bypassed in dev)
- Login authenticates and redirects to dashboard
- Session persists across page refresh and browser close/reopen
- Protected routes redirect to login when not authenticated
- Each user has their own tenant_id (multi-tenant isolation)
- Logout clears session
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-06-SUMMARY.md`

This summary should document:
- All verification steps completed
- Any issues found and resolved
- Confirmation that Phase 1 requirements are met
</output>
