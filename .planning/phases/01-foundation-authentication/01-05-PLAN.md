---
phase: 01-foundation-authentication
plan: 05
type: execute
wave: 4
depends_on: ["01-01", "01-02", "01-03", "01-04"]
files_modified:
  - src/app/(auth)/login/page.tsx
  - src/app/(auth)/login/actions.ts
  - src/app/(dashboard)/page.tsx
  - src/app/(dashboard)/layout.tsx
  - src/app/(auth)/logout/actions.ts
  - src/components/LogoutButton.tsx
autonomous: true

must_haves:
  truths:
    - "User can see login form at /login"
    - "User can log in with valid credentials"
    - "Invalid credentials show error message"
    - "After login, user is redirected to /dashboard"
    - "Dashboard shows user email and tenant info"
    - "User can log out and is redirected to /login"
    - "Unauthenticated users accessing /dashboard are redirected to /login"
  artifacts:
    - path: "src/app/(auth)/login/page.tsx"
      provides: "Login form UI"
      min_lines: 30
    - path: "src/app/(auth)/login/actions.ts"
      provides: "Login server action"
      exports: ["login"]
    - path: "src/app/(dashboard)/page.tsx"
      provides: "Protected dashboard"
      min_lines: 20
    - path: "src/app/(auth)/logout/actions.ts"
      provides: "Logout server action"
      exports: ["logout"]
  key_links:
    - from: "src/app/(auth)/login/actions.ts"
      to: "supabase.auth.signInWithPassword"
      via: "server action"
      pattern: "supabase\\.auth\\.signInWithPassword"
    - from: "src/app/(dashboard)/page.tsx"
      to: "verifySession"
      via: "import from DAL"
      pattern: "import.*verifySession.*from.*dal/auth"
    - from: "src/app/(auth)/logout/actions.ts"
      to: "supabase.auth.signOut"
      via: "server action"
      pattern: "supabase\\.auth\\.signOut"
---

<objective>
Implement login flow, protected dashboard, and logout functionality.

Purpose: Complete the authentication cycle - users can log in, see their personalized dashboard with tenant info, and log out.
Output: Working login page, protected dashboard with session verification, and logout action.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-01-SUMMARY.md
@.planning/phases/01-foundation-authentication/01-03-SUMMARY.md
@.planning/phases/01-foundation-authentication/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create login page and action</name>
  <files>
    src/app/(auth)/login/page.tsx
    src/app/(auth)/login/actions.ts
  </files>
  <action>
    Create the login page and server action:

    1. `src/app/(auth)/login/page.tsx`:
       - Client Component with useActionState
       - Form fields: email, password
       - Display errors from server action state
       - Link to /signup for new users
       - Tailwind styling: centered card, clean design

       ```tsx
       'use client'

       import { useActionState } from 'react'
       import { login } from './actions'
       import Link from 'next/link'

       export default function LoginPage() {
         const [state, formAction, pending] = useActionState(login, null)

         return (
           <div className="min-h-screen flex items-center justify-center bg-gray-50">
             <div className="max-w-md w-full p-8 bg-white rounded-lg shadow">
               <h1 className="text-2xl font-bold mb-6 text-center">Log In</h1>
               <form action={formAction} className="space-y-4">
                 {state?.error && (
                   <div className="p-3 bg-red-50 text-red-600 rounded text-sm">
                     {state.error}
                   </div>
                 )}
                 <div>
                   <label htmlFor="email" className="block text-sm font-medium mb-1">
                     Email
                   </label>
                   <input
                     id="email"
                     name="email"
                     type="email"
                     required
                     className="w-full px-3 py-2 border rounded-md"
                   />
                 </div>
                 <div>
                   <label htmlFor="password" className="block text-sm font-medium mb-1">
                     Password
                   </label>
                   <input
                     id="password"
                     name="password"
                     type="password"
                     required
                     className="w-full px-3 py-2 border rounded-md"
                   />
                 </div>
                 <button
                   type="submit"
                   disabled={pending}
                   className="w-full py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50"
                 >
                   {pending ? 'Logging in...' : 'Log In'}
                 </button>
               </form>
               <p className="mt-4 text-center text-sm text-gray-600">
                 Don&apos;t have an account?{' '}
                 <Link href="/signup" className="text-blue-600 hover:underline">
                   Sign up
                 </Link>
               </p>
             </div>
           </div>
         )
       }
       ```

    2. `src/app/(auth)/login/actions.ts`:
       ```typescript
       'use server'

       import { revalidatePath } from 'next/cache'
       import { redirect } from 'next/navigation'
       import { createClient } from '@/lib/supabase/server'

       export async function login(prevState: any, formData: FormData) {
         const supabase = await createClient()

         const email = formData.get('email') as string
         const password = formData.get('password') as string

         if (!email || !password) {
           return { error: 'Email and password are required' }
         }

         const { error } = await supabase.auth.signInWithPassword({
           email,
           password,
         })

         if (error) {
           return { error: error.message }
         }

         revalidatePath('/', 'layout')
         redirect('/dashboard')
       }
       ```
  </action>
  <verify>
    - Both files exist
    - TypeScript compiles: `npx tsc --noEmit`
    - Login page renders at /login (npm run dev)
    - Server action exports login function
  </verify>
  <done>
    Login page with form and server action that authenticates and redirects to dashboard
  </done>
</task>

<task type="auto">
  <name>Task 2: Create protected dashboard</name>
  <files>
    src/app/(dashboard)/page.tsx
    src/app/(dashboard)/layout.tsx
  </files>
  <action>
    Create the protected dashboard with session verification:

    1. `src/app/(dashboard)/layout.tsx`:
       - Server Component that wraps all dashboard pages
       - Can include navigation shell (optional for now)
       ```tsx
       export default function DashboardLayout({
         children,
       }: {
         children: React.ReactNode
       }) {
         return (
           <div className="min-h-screen bg-gray-50">
             {children}
           </div>
         )
       }
       ```

    2. `src/app/(dashboard)/page.tsx`:
       - Server Component that verifies session
       - Uses verifySession from DAL (redirects to /login if not auth)
       - Displays user email and tenant ID to prove session works
       - Includes logout button

       ```tsx
       import { verifySession } from '@/lib/dal/auth'
       import { LogoutButton } from '@/components/LogoutButton'

       export default async function DashboardPage() {
         const session = await verifySession()

         return (
           <div className="max-w-4xl mx-auto p-8">
             <div className="flex justify-between items-center mb-8">
               <h1 className="text-3xl font-bold">Dashboard</h1>
               <LogoutButton />
             </div>

             <div className="bg-white rounded-lg shadow p-6">
               <h2 className="text-xl font-semibold mb-4">Welcome!</h2>
               <p className="text-gray-600 mb-2">
                 You are logged in as: <strong>{session.email}</strong>
               </p>
               <p className="text-gray-600 mb-2">
                 User ID: <code className="bg-gray-100 px-2 py-1 rounded">{session.userId}</code>
               </p>
               {session.tenantId && (
                 <p className="text-gray-600">
                   Tenant ID: <code className="bg-gray-100 px-2 py-1 rounded">{session.tenantId}</code>
                 </p>
               )}
             </div>

             <div className="mt-8 p-4 bg-green-50 rounded-lg">
               <p className="text-green-800">
                 Session is valid and persists across browser refresh.
                 Tenant isolation is enforced at the database level via RLS.
               </p>
             </div>
           </div>
         )
       }
       ```

    CRITICAL: The page uses `verifySession()` which:
    - Calls supabase.auth.getUser() (validates JWT with Supabase)
    - Fetches tenant_id from profiles table
    - Redirects to /login if not authenticated
    - Is cached per-request for performance
  </action>
  <verify>
    - Both files exist
    - TypeScript compiles: `npx tsc --noEmit`
    - Dashboard uses verifySession from DAL
    - Shows user email and tenant info
  </verify>
  <done>
    Protected dashboard verifies session and displays user/tenant info
  </done>
</task>

<task type="auto">
  <name>Task 3: Create logout functionality</name>
  <files>
    src/app/(auth)/logout/actions.ts
    src/components/LogoutButton.tsx
  </files>
  <action>
    Create the logout action and button component:

    1. `src/app/(auth)/logout/actions.ts`:
       ```typescript
       'use server'

       import { revalidatePath } from 'next/cache'
       import { redirect } from 'next/navigation'
       import { createClient } from '@/lib/supabase/server'

       export async function logout() {
         const supabase = await createClient()
         await supabase.auth.signOut()
         revalidatePath('/', 'layout')
         redirect('/login')
       }
       ```

    2. `src/components/LogoutButton.tsx`:
       - Client Component that calls the logout action
       ```tsx
       'use client'

       import { logout } from '@/app/(auth)/logout/actions'

       export function LogoutButton() {
         return (
           <form action={logout}>
             <button
               type="submit"
               className="px-4 py-2 text-sm text-gray-600 hover:text-gray-900 border rounded-md hover:bg-gray-50"
             >
               Log Out
             </button>
           </form>
         )
       }
       ```
  </action>
  <verify>
    - Both files exist
    - TypeScript compiles: `npx tsc --noEmit`
    - Logout action calls signOut and redirects to /login
    - LogoutButton is a Client Component using form action
  </verify>
  <done>
    Logout action signs out user and redirects, LogoutButton component uses server action
  </done>
</task>

</tasks>

<verification>
1. All login/dashboard/logout files exist
2. TypeScript compiles without errors
3. Login page shows at /login
4. Dashboard shows at /dashboard (when authenticated)
5. Dashboard redirects to /login when not authenticated
6. Logout button signs out and redirects to /login
</verification>

<success_criteria>
- Login form validates credentials with Supabase Auth
- Successful login redirects to /dashboard
- Invalid login shows error message
- Dashboard is protected by verifySession (redirects if not auth)
- Dashboard displays user email and tenant ID
- Logout clears session and redirects to /login
- Session persists across browser refresh
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-05-SUMMARY.md`
</output>
