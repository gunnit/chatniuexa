---
phase: 01-foundation-authentication
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00001_initial_schema.sql
  - src/types/database.ts
autonomous: true

must_haves:
  truths:
    - "Tenants table exists in Supabase database"
    - "Profiles table exists linked to auth.users"
    - "RLS is enabled on both tables"
    - "get_tenant_id() helper function exists"
    - "Users can only see their own tenant and profile"
  artifacts:
    - path: "supabase/migrations/00001_initial_schema.sql"
      provides: "Database schema migration"
      contains: "CREATE TABLE public.tenants"
    - path: "src/types/database.ts"
      provides: "TypeScript types for database tables"
      contains: "interface Tenant"
  key_links:
    - from: "profiles table"
      to: "auth.users"
      via: "foreign key on id"
      pattern: "REFERENCES auth.users"
    - from: "profiles table"
      to: "tenants table"
      via: "foreign key on tenant_id"
      pattern: "REFERENCES public.tenants"
    - from: "RLS policies"
      to: "get_tenant_id()"
      via: "policy USING clause"
      pattern: "get_tenant_id\\(\\)"
---

<objective>
Create the database schema for multi-tenant authentication with Row-Level Security.

Purpose: Establish the data foundation for multi-tenant isolation. Every user belongs to a tenant, and RLS policies ensure users can only access their own tenant's data.
Output: SQL migration file and TypeScript types for tenants and profiles tables.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database schema migration</name>
  <files>
    supabase/migrations/00001_initial_schema.sql
  </files>
  <action>
    Create the SQL migration file following the schema from 01-RESEARCH.md "Database Schema for Phase 1":

    1. Create `public.tenants` table:
       - id: uuid PRIMARY KEY DEFAULT gen_random_uuid()
       - name: text NOT NULL
       - created_at: timestamptz DEFAULT now() NOT NULL
       - updated_at: timestamptz DEFAULT now() NOT NULL

    2. Enable RLS on tenants table

    3. Create `public.profiles` table:
       - id: uuid PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE
       - tenant_id: uuid NOT NULL REFERENCES public.tenants(id)
       - full_name: text
       - created_at: timestamptz DEFAULT now() NOT NULL
       - updated_at: timestamptz DEFAULT now() NOT NULL

    4. Enable RLS on profiles table

    5. Create helper function `public.get_tenant_id()`:
       - Returns uuid
       - LANGUAGE sql STABLE SECURITY DEFINER
       - SELECT tenant_id FROM public.profiles WHERE id = auth.uid()

    6. Create RLS policies:
       - tenants: "Users can view their own tenant" - SELECT where id = get_tenant_id()
       - profiles: "Users can view their own profile" - SELECT where id = auth.uid()
       - profiles: "Users can update their own profile" - UPDATE where id = auth.uid()

    7. Create index for performance:
       - idx_profiles_tenant_id ON public.profiles(tenant_id)

    8. Create updated_at trigger function and apply to both tables

    IMPORTANT: Also add INSERT policies for profiles:
       - "Users can insert their own profile" - INSERT with check (id = auth.uid())

    Note: This migration is designed to be run via Supabase Dashboard SQL Editor or Supabase CLI.
    The file serves as documentation and version control for the schema.
  </action>
  <verify>
    - File exists at supabase/migrations/00001_initial_schema.sql
    - SQL syntax is valid (no obvious errors)
    - Contains CREATE TABLE for tenants and profiles
    - Contains ENABLE ROW LEVEL SECURITY for both tables
    - Contains RLS policies
    - Contains get_tenant_id() function
  </verify>
  <done>
    SQL migration file exists with complete schema for multi-tenant auth
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript database types</name>
  <files>
    src/types/database.ts
  </files>
  <action>
    Create TypeScript type definitions for the database tables.

    Note: In a full Supabase project, you would generate these with `supabase gen types typescript`.
    For now, create manual types that match the schema:

    ```typescript
    export interface Tenant {
      id: string
      name: string
      created_at: string
      updated_at: string
    }

    export interface Profile {
      id: string
      tenant_id: string
      full_name: string | null
      created_at: string
      updated_at: string
    }

    // Database schema type for Supabase client
    export interface Database {
      public: {
        Tables: {
          tenants: {
            Row: Tenant
            Insert: Omit<Tenant, 'id' | 'created_at' | 'updated_at'> & {
              id?: string
              created_at?: string
              updated_at?: string
            }
            Update: Partial<Omit<Tenant, 'id' | 'created_at' | 'updated_at'>> & {
              updated_at?: string
            }
          }
          profiles: {
            Row: Profile
            Insert: Omit<Profile, 'created_at' | 'updated_at'> & {
              created_at?: string
              updated_at?: string
            }
            Update: Partial<Omit<Profile, 'id' | 'tenant_id' | 'created_at' | 'updated_at'>> & {
              updated_at?: string
            }
          }
        }
        Functions: {
          get_tenant_id: {
            Args: Record<string, never>
            Returns: string
          }
        }
      }
    }
    ```

    This type structure follows the Supabase TypeScript pattern and can be used to type the Supabase client.
  </action>
  <verify>
    - File exists at src/types/database.ts
    - TypeScript compiles without errors: `npx tsc --noEmit`
    - Exports Database, Tenant, and Profile types
  </verify>
  <done>
    TypeScript types exist for database tables, ready for use with typed Supabase client
  </done>
</task>

</tasks>

<verification>
1. Migration file exists with valid SQL
2. TypeScript types file exists and compiles
3. SQL contains all required tables, RLS policies, and helper function
4. Types match the schema structure
</verification>

<success_criteria>
- SQL migration file documents complete multi-tenant schema
- RLS policies enforce tenant isolation at database level
- TypeScript types provide type safety for database operations
- Schema follows patterns from research (get_tenant_id helper, proper indexing)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-02-SUMMARY.md`

NOTE: The SQL migration must be executed in Supabase (either via CLI or Dashboard SQL Editor) before the auth flows will work. This will be validated during the end-to-end verification checkpoint.
</output>
